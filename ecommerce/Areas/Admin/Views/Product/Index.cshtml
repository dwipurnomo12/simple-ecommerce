@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "List Product";
}


<div class="page-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-white bg-primary">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="mb-0 text-white">Product List</h4>
                            </div>
                            <div class="col-md-6">
                                <button id="btn_add_product" type="button" class="btn btn-light float-end"><i
                                        class="fas fa-plus-square"></i>
                                    Add Product</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="datatable" class="table border table-striped table-bordered text-nowrap">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">No</th>
                                        <th style="text-align: left;">Image</th>
                                        <th style="text-align: left;">SKU</th>
                                        <th style="text-align: left;">Product</th>
                                        <th style="text-align: left;">Stock</th>
                                        <th style="text-align: left;">Active</th>
                                        <th style="text-align: left;">Option</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot>
                                    <tr>
    
                                        <th style="text-align: left;">No</th>
                                        <th style="text-align: left;">Image</th>
                                        <th style="text-align: left;">SKU</th>
                                        <th style="text-align: left;">Product</th>
                                        <th style="text-align: left;">Stock</th>
                                        <th style="text-align: left;">Active</th>
                                        <th style="text-align: left;">Option</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        // Inisialisasi DataTable sekali saja
        var table = $('#datatable').DataTable({
            columnDefs: [
                { targets: [0, 1, 2], className: 'text-start' }
            ]
        });

        // function load datatable
        function loadDataTable() {
            $.ajax({
                url: '/Admin/Product/GetProducts',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    table.clear();
                    $.each(data.data, function (index, product) {
                        table.row.add([
                            index + 1,
                            '<img src="' + product.featuredImage + '" alt="Product Image" class="img-thumbnail" style="width: 50px; height: 50px;">',
                            product.sku,
                            product.name,
                            product.stock,
                            product.isActive ? 'Active' : 'Inactive',
                            '<button type="button" id="btn_detail_product" data-id="' + category.id + '" class="btn btn-success btn-circle me-2"><i class="fas fa-eye"></i></button>' +
                            '<button type="button" id="btn_edit_product" data-id="' + category.id + '" class="btn btn-warning btn-circle me-2"><i class="fas fa-pencil-alt"></i></button>' +
                            '<button type="button" id="btn_delete_product" data-id="' + category.id + '" class="btn btn-danger btn-circle"><i class="fas fa-trash"></i></button>'
                        ]);
                    });
                    table.draw();
                },
                error: function (xhr, status, error) {
                    console.error('Error loading data:', error);
                }
            });
        }

        // load datatable on page load
        loadDataTable();

        // clear value form input
        function clearForm() {
            $('#Name').val('');
            $('#NameEdit').val('');
            $('#Name-error').text('');
            $('#Name_edit-error').text('');
        }

        // Show modal add category
        $('body').on('click', '#btn_add_product', function () {
            clearForm();
            $('#add_product_modal').modal('show');
        });

        // Store category
        $('#Store').click(function (e) {
            e.preventDefault();

            let Name = $('#Name').val();
            let formData = new FormData();
            formData.append('Name', Name);
            formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            $.ajax({
                url: '/Admin/Product/Create',
                type: "POST",
                cache: false,
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    console.log(response);
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: response.message,
                            showConfirmButton: true,
                            timer: 3000
                        });

                        $('#add_product_modal').modal('hide'); // Hide modal
                        loadDataTable(); // Reload data
                    } else {
                        $('#Name-error').text(response.message);
                    }
                }
            });
        });

        // Show modal edit category
        $('body').on('click', '#btn_edit_product', function () {
            let categoryId = $(this).data('id');

            $.ajax({
                url: '/Admin/Product/Edit/' + categoryId,
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        clearForm();
                        $('#edit_product_modal').modal('show');

                        $('#Name_edit').val(response.data.name);
                        $('#category_id').val(categoryId);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message,
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading category:', error);
                }
            })
        });
        // Update category
        $('#Update').click(function (e) {
            e.preventDefault();

            let categoryId = $('#category_id').val();
            let Name = $('#Name_edit').val();
            let formData = new FormData();
            formData.append('Id', categoryId);
            formData.append('Name', Name);
            formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            $.ajax({
                url: '/Admin/Product/Edit',
                type: "POST",
                cache: false,
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: response.message,
                            showConfirmButton: true,
                            timer: 3000
                        });

                        $('#edit_product_modal').modal('hide'); // Hide modal
                        loadDataTable(); // Reload data
                    } else {
                        $('#Name_edit-error').text(response.message);
                    }
                }
            });
        });

        // Delete a category
        $('body').on('click', '#btn_delete_product', function () {
            let id = $(this).data('id');
            let token = $('input[name="__RequestVerificationToken"]').val();

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Admin/Product/Delete',
                        type: 'POST',
                        data: { id: id, __RequestVerificationToken: token },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: response.message,
                                    showConfirmButton: true,
                                    timer: 3000
                                });

                                loadDataTable();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message,
                                });
                            }
                        }
                    });
                }
            });
        });

    });
</script>
